name: üé≤ Lottery Full Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'
permissions:
  contents: write
  id-token: write
  pages: write
jobs:
  daily-analysis:
    name: üìä Daily Analysis
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install requests beautifulsoup4
      - name: üì• Download latest CSV data
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import time
          import urllib3
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
          print("üì• Downloading latest lottery data...")
          urls = {
              'Melate.csv': 'https://www.loterianacional.gob.mx/Home/Historicos?ARHP=TQBlAGwAYQB0AGUA',
              'Revancha.csv': 'https://www.loterianacional.gob.mx/Home/Historicos?ARHP=UgBlAHYAYQBuAGMAaABhAA==',
              'Revanchita.csv': 'https://www.loterianacional.gob.mx/Home/Historicos?ARHP=UgBlAHYAYQBuAGMAaABpAHQAYQA=',
              'MelateRetro.csv': 'https://www.loterianacional.gob.mx/Home/Historicos?ARHP=TQBlAGwAYQB0AGUALQBSAGUAdAByAG8A',
              'Tris.csv': 'https://www.loterianacional.gob.mx/Home/Historicos?ARHP=VAByAGkAcwA=',
              'Chispazo.csv': 'https://www.loterianacional.gob.mx/Home/Historicos?ARHP=QwBoAGkAcwBwAGEAegBvAA=='
          }
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
          for fname, url in urls.items():
              print(f"Downloading {fname}...")
              r = requests.get(url, headers=headers, verify=False)
              with open(fname, 'wb') as f:
                  f.write(r.content)
          print("‚úÖ All CSVs downloaded.")
          PYTHON_SCRIPT
      - name: üìä Run Melate analysis
        run: python melate.py
      - name: üìä Run Melate Retro analysis
        run: python melate_retro.py
      - name: üìä Run Tris analysis
        run: python tris.py
      - name: üìä Run Chispazo analysis
        run: python chispazo.py
      - name: üåê Convert Markdown to HTML
        run: |
          mkdir -p docs
          python3 << 'PYTHON_SCRIPT'
          import markdown2
          from datetime import datetime

          # Read the markdown files
          with open('ANALISIS.md', 'r', encoding='utf-8') as f:
            analisis_content = f.read()

          with open('METODOLOGIA.md', 'r', encoding='utf-8') as f:
            metodologia_content = f.read()

          # Melate Retro
          try:
            with open('ANALISIS_RETRO.md', 'r', encoding='utf-8') as f:
              retro_content = f.read()
            retro_html = markdown2.markdown(retro_content, extras=['tables', 'fenced-code-blocks'])
          except FileNotFoundError:
            retro_html = '<h2>No se encontr√≥ ANALISIS_RETRO.md</h2>'

          # Tris
          try:
            with open('ANALISIS_TRIS.md', 'r', encoding='utf-8') as f:
              tris_content = f.read()
            tris_html = markdown2.markdown(tris_content, extras=['tables', 'fenced-code-blocks'])
          except FileNotFoundError:
            tris_html = '<h2>No se encontr√≥ ANALISIS_TRIS.md</h2>'

          # Chispazo
          try:
            with open('ANALISIS_CHISPAZO.md', 'r', encoding='utf-8') as f:
              chispazo_content = f.read()
            chispazo_html = markdown2.markdown(chispazo_content, extras=['tables', 'fenced-code-blocks'])
          except FileNotFoundError:
            chispazo_html = '<h2>No se encontr√≥ ANALISIS_CHISPAZO.md</h2>'

          # Convert main analysis and methodology to HTML
          analisis_html = markdown2.markdown(analisis_content, extras=['tables', 'fenced-code-blocks'])
          metodologia_html = markdown2.markdown(metodologia_content, extras=['tables', 'fenced-code-blocks'])

          # Create the full HTML page template
          html_template = '''<!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{title}</title>
            <style>
              :root {{
                --primary-color: #2563eb;
                --secondary-color: #10b981;
                --background: #f8fafc;
                --card-bg: #ffffff;
                --text-primary: #1e293b;
                --text-secondary: #64748b;
                --border: #e2e8f0;
              }}
              * {{ margin: 0; padding: 0; box-sizing: border-box; }}
              body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; line-height: 1.6; color: var(--text-primary); background: var(--background); padding: 20px; }}
              .container {{ max-width: 1200px; margin: 0 auto; }}
              header {{ background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 40px 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }}
              header h1 {{ font-size: 2.5em; margin-bottom: 10px; }}
              .subtitle {{ font-size: 1.1em; opacity: 0.9; }}
              .content {{ background: var(--card-bg); border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }}
              h1 {{ color: var(--primary-color); margin: 30px 0 20px 0; font-size: 2em; border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; }}
              h2 {{ color: var(--primary-color); margin: 25px 0 15px 0; font-size: 1.6em; border-bottom: 2px solid var(--secondary-color); padding-bottom: 8px; }}
              h3 {{ color: var(--text-primary); margin: 20px 0 10px 0; font-size: 1.3em; }}
              h4 {{ color: var(--text-secondary); margin: 15px 0 10px 0; font-size: 1.1em; }}
              table {{ width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }}
              th, td {{ padding: 12px 15px; text-align: center; border: 1px solid var(--border); }}
              th {{ background: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.5px; }}
              tr:nth-child(even) {{ background: #f8fafc; }}
              tr:hover {{ background: #e0f2fe; transition: background 0.3s ease; }}
              ul, ol {{ margin: 15px 0; padding-left: 30px; }}
              li {{ margin: 8px 0; }}
              strong {{ color: var(--primary-color); font-weight: 600; }}
              code, pre {{ background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.9em; }}
              pre {{ padding: 15px; overflow-x: auto; margin: 15px 0; border-left: 4px solid var(--primary-color); }}
              pre code {{ background: none; padding: 0; }}
              blockquote {{ background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px 20px; margin: 20px 0; border-radius: 4px; font-style: italic; }}
              hr {{ border: none; border-top: 2px solid var(--border); margin: 30px 0; }}
              .footer {{ text-align: center; margin-top: 40px; padding: 30px; background: var(--card-bg); border-radius: 12px; color: var(--text-secondary); font-size: 0.95em; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }}
              .footer a {{ color: var(--primary-color); text-decoration: none; font-weight: 600; }}
              .footer a:hover {{ text-decoration: underline; }}
              @media (max-width: 768px) {{ body {{ padding: 10px; }} header h1 {{ font-size: 1.8em; }} .content {{ padding: 20px; }} table {{ font-size: 0.85em; }} th, td {{ padding: 8px 6px; }} }}
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>{header_title}</h1>
                <p class="subtitle">{subtitle}</p>
              </header>
              <div class="content">{content}</div>
              <div class="footer">
                <p>ü§ñ Generado autom√°ticamente por GitHub Actions</p>
                <p>üìä Actualizado diariamente a las 8:00 AM UTC</p>
                <p style="margin-top: 10px;">
                  <a href="https://github.com/mariotristan/melate" target="_blank">üìÇ Ver c√≥digo fuente en GitHub</a>
                </p>
              </div>
            </div>
          </body>
          </html>
          '''

          # Navegaci√≥n entre an√°lisis
          nav_html = '''<nav style="margin-bottom:30px;text-align:center;">
            <a href="index.html" style="margin:0 18px;font-weight:600;color:#2563eb;">Inicio</a>
            <a href="melate.html" style="margin:0 18px;font-weight:600;color:#2563eb;">Melate Cl√°sico</a>
            <a href="RETRO.html" style="margin:0 18px;font-weight:600;color:#10b981;">Melate Retro</a>
            <a href="TRIS.html" style="margin:0 18px;font-weight:600;color:#f59e0b;">Tris</a>
            <a href="CHISPAZO.html" style="margin:0 18px;font-weight:600;color:#e11d48;">Chispazo</a>
            <a href="METODOLOGIA.html" style="margin:0 18px;font-weight:600;color:#64748b;">Metodolog√≠a</a>
          </nav>'''

          # Generate tris.html
          tris_page = html_template.format(
            title='üé≤ Tris - An√°lisis',
            header_title='üé≤ Tris',
            subtitle='An√°lisis estad√≠stico Tris',
            content=nav_html + tris_html
          )
          with open('docs/TRIS.html', 'w', encoding='utf-8') as f:
            f.write(tris_page)

          analisis_page = html_template.format(
            title='üé≤ An√°lisis de Loter√≠a Melate',
            header_title='üé≤ An√°lisis de Loter√≠a Melate',
            subtitle='An√°lisis estad√≠stico avanzado de sorteos mexicanos',
            content=nav_html + analisis_html
          )
          with open('docs/melate.html', 'w', encoding='utf-8') as f:
            f.write(analisis_page)

          metodologia_page = html_template.format(
            title='üìö Metodolog√≠a y Fundamentos Estad√≠sticos',
            header_title='üìö Metodolog√≠a y Fundamentos Estad√≠sticos',
            subtitle='Bases te√≥ricas del an√°lisis de loter√≠a',
            content=nav_html + metodologia_html
          )
          with open('docs/METODOLOGIA.html', 'w', encoding='utf-8') as f:
            f.write(metodologia_page)

          retro_page = html_template.format(
            title='üé≤ Melate Retro - An√°lisis',
            header_title='üé≤ Melate Retro',
            subtitle='An√°lisis estad√≠stico Melate Retro',
            content=nav_html + retro_html
          )
          with open('docs/RETRO.html', 'w', encoding='utf-8') as f:
            f.write(retro_page)

          chispazo_page = html_template.format(
            title='üé≤ Chispazo - An√°lisis',
            header_title='üé≤ Chispazo',
            subtitle='An√°lisis estad√≠stico Chispazo',
            content=nav_html + chispazo_html
          )
          with open('docs/CHISPAZO.html', 'w', encoding='utf-8') as f:
            f.write(chispazo_page)

          print("‚úÖ HTML pages generated successfully!")
          PYTHON_SCRIPT
          # ...existing code...
      - name: üì§ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'
  deploy:
    name: üöÄ Deploy to GitHub Pages
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    needs: daily-analysis
    steps:
      - name: üåê Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
